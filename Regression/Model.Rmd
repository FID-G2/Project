# Modelo de regresión

## Imports necesarios

```{r}
#install.packages("caret")
#install.packages("rpart")
#install.packages("lightgbm")
#install.packages("randomForest")
#install.packages("r2r")
```

```{r}
library(randomForest)
library(caret)
library(rpart)
library(lightgbm)
library(r2r)
```

## 1. Lectura de los datos

Lectura de los datos obtenidos tras aplicar el proceso de selección.

```{r}

df <- read.csv("../data/CleanData/datos_seleccion_atributos.csv")
control <- trainControl(method = "cv", number = 10)
```

## 2. Modelos

### 2.1. Random Forest

```{r}

model_rf <- train(Nota.media ~ ., data = df, method = "rf", trControl = control, tuneGrid = data.frame(mtry = 2), ntree = 10)
print(model_rf)
```

### 2.2. LightGBM

```{r}

data <- as.matrix(df[, -which(names(df) == "Nota.media")])
label <- df$Nota.media

# Crear un conjunto de datos de LightGBM
lgb_data <- lgb.Dataset(data = data, label = label)

# Especificar los parámetros del modelo
params <- list(objective = "regression",
               metric = list("rmse","mse", "mae"), #TODO: Ver como se puede modificar esto para que salgan todas las métricas
               num_leaves = 31,
               learning_rate = 0.05,
               nthread = 2,
               max_depth = 2,
               min_data_in_leaf = 20)

# Entrenar el modelo con validación cruzada
cv_results <- lgb.cv(params,
                     data = lgb_data,
                     nrounds = 10,
                     nfold = 10,
                     verbose = 0)

# Mostrar los resultados
print(cv_results)
```

**RMSE**

```{r}

cv_results$record_evals$valid$rmse
```

**MAE**

```{r}

cv_results$record_evals$valid$l1
```

**MSE**

```{r}

cv_results$record_evals$valid$l2
```

### 2.3. Decision Tree

```{r}

model_tree <- train(Nota.media ~ ., data = df, method = "rpart", trControl = control, control = rpart.control(cp = 1))

print(model_tree)

```

## 3. Predicción sobre modelos

### 3.1. Dataframe auxiliar de PCAs

```{r}

data <- read.csv("../data/CleanData/var_PCAs.csv")
head(data)
```

### 3.2. Hashes auxiliares

```{r}

claves_comunidades <- c("Andalucía","Aragón", "Asturias", "Cantabria", "Castilla y León", "Cataluña", "Extremadura", "Galicia", "La Rioja", "Madrid", "Murcia", "Navarra", "País Vasco")

valores_comunidades <- c("Comunidad.AutónomaAndalucía","Comunidad.AutónomaAragón", "Comunidad.AutónomaAsturias", "Comunidad.AutónomaCantabria", "Comunidad.AutónomaCastilla.y.León", "Comunidad.AutónomaCataluña", "Comunidad.AutónomaExtremadura", "Comunidad.AutónomaGalicia", "Comunidad.AutónomaLa.Rioja", "Comunidad.AutónomaMadrid", "Comunidad.AutónomaMurcia", "Comunidad.AutónomaNavarra", "Comunidad.AutónomaPaís.Vasco")

comunidades <- hashmap()
comunidades[claves_comunidades] <- valores_comunidades

claves_ramas_enseñanza <- c("Artes y Humanidades", "Ciencias", "Ciencias de la Salud", "Ciencias Sociales y Jurídicas", "Ingeniería y Arquitectura")

valores_ramas_enseñanza <- c("Rama.de.enseñanzaArtes.y.Humanidades","Rama.de.enseñanzaCiencias", "Rama.de.enseñanzaCiencias.de.la.Salud", "Rama.de.enseñanzaCiencias.Sociales.y.Jurídicas", "Rama.de.enseñanzaIngeniería.y.Arquitectura")

ramas_enseñanza <- hashmap()
ramas_enseñanza[claves_ramas_enseñanza] <- valores_ramas_enseñanza

claves_ambitos_estudio <- c("Arquitectura y construcción", "Artes", "Ciencias de la vida", "Ciencias Físicas, químicas, geológicas", "Derecho", "Economía", "Enfermería y atención a enfermos", "Humanidades", "Informática", "Ingenierías", "Lenguas", "Medicina", "Periodismo e información", "Trabajo social y orientación")

valores_ambitos_estudio <- c("Ámbito.de.estudioArquitectura.y.construcción", "Ámbito.de.estudioArtes", "Ámbito.de.estudioCiencias.de.la.vida", "Ámbito.de.estudioCiencias.Físicas..químicas..geológicas", "Ámbito.de.estudioDerecho", "Ámbito.de.estudioEconomía", "Ámbito.de.estudioEnfermería.y.atención.a.enfermos", "Ámbito.de.estudioHumanidades", "Ámbito.de.estudioInformática", "Ámbito.de.estudioIngenierías", "Ámbito.de.estudioLenguas", "Ámbito.de.estudioMedicina", "Ámbito.de.estudioPeriodismo.e.información", "Ámbito.de.estudioTrabajo.social.y.orientación")
  
ambitos_estudio <- hashmap()
ambitos_estudio[claves_ambitos_estudio] <- valores_ambitos_estudio

valores_ambitos_estudio_ramas_enseñanza <- c("Rama.de.enseñanzaIngeniería.y.Arquitectura", "Rama.de.enseñanzaArtes.y.Humanidades", "Rama.de.enseñanzaCiencias", "Rama.de.enseñanzaCiencias", "Rama.de.enseñanzaCiencias.Sociales.y.Jurídicas", "Rama.de.enseñanzaCiencias.Sociales.y.Jurídicas", "Rama.de.enseñanzaCiencias.de.la.Salud", "Rama.de.enseñanzaArtes.y.Humanidades", "Rama.de.enseñanzaCiencias", "Rama.de.enseñanzaIngeniería.y.Arquitectura", "Rama.de.enseñanzaArtes.y.Humanidades", "Rama.de.enseñanzaCiencias.de.la.Salud", "Rama.de.enseñanzaCiencias.Sociales.y.Jurídicas", "Rama.de.enseñanzaCiencias.Sociales.y.Jurídicas")

ambitos_estudio_ramas_enseñanza <- hashmap()
ambitos_estudio_ramas_enseñanza[valores_ambitos_estudio] <- valores_ambitos_estudio_ramas_enseñanza

claves_zonas_nacionalidad <- c("Asia y Oceanía", "EEUU y Canadá", "España", "Norte de África", "Resto de África", "Resto de Europa", "Unión Europea")

valores_zonas_nacionalidad <- c("Zona.de.nacionalidadAsia.y.Oceanía", "Zona.de.nacionalidadEEUU.y.Canadá", "Zona.de.nacionalidadEspaña", "Zona.de.nacionalidadNorte.de.África", "Zona.de.nacionalidadResto.de.África", "Zona.de.nacionalidadResto.de.Europa", "Zona.de.nacionalidadUnión.Europea")

zonas_nacionalidad <- hashmap()
zonas_nacionalidad[claves_zonas_nacionalidad] <- valores_zonas_nacionalidad


```

### 3.3. Funciones auxiliares

```{r}

binary_encode <- function(data, variable, category1, category2) {
  # Crear una nueva columna con la codificación binaria
  data[[variable]] <- ifelse(data[[variable]] == category1, 0, 1)

  # Devolver el conjunto de datos modificado
  return(data)
}
```

```{r}

agregar_datos_pca <- function(data, df_indices, nombre_columna, prefijo_pca) {

  # Obtener el nombre de la comunidad y la fila correspondiente
  valor <- data[[nombre_columna]]
  fila <- df_indices[df_indices$Variable == valor, ]

  # Verificar si se encontró la fila
  if (nrow(fila) > 0) {
    # Extraer los valores de PCA de la fila
    valores_pca <- fila[, grepl("^PCA", colnames(fila))]

    colnames(valores_pca) <- paste0(prefijo_pca, colnames(valores_pca))

    # Agregar las columnas de PCA al dataframe de datos
    data_con_pca <- cbind(data, valores_pca)
    
    data_con_pca <- data_con_pca[, !colnames(data_con_pca) %in% nombre_columna, drop = FALSE]

    return(data_con_pca)
  } else {
    cat("No se encontró la fila correspondiente para el valor:", valor, "\n")
    return(NULL)
  }
}
```

```{r}

adaptar_dataframe <- function(df){
  
  df_genero <- binary_encode(df, "Sexo", "Hombres", "Mujeres")
  df_nivel <- binary_encode(df_genero, "Forma.de.admisión", "PAU", "FP")
  
  if(!has_key(comunidades, df_nivel$Comunidad.Autónoma)){
    cat("Posibles valores para Comunidad.Autónoma:", paste(keys(comunidades), collapse = ", "))
    stop("Asígnele un valor válido a Comunidad.Autónoma")
  }
  df_nivel$Comunidad.Autónoma <- comunidades[df_nivel$Comunidad.Autónoma]
  
  if (!has_key(ambitos_estudio, df_nivel$Ámbito.de.estudio)) {
    cat("Posibles valores para Ámbito.de.estudio:", paste(keys(ambitos_estudio), collapse = ", "))
    stop("Asígnele un valor válido a Ámbito.de.estudio")
  }
  df_nivel$Ámbito.de.estudio <- ambitos_estudio[[df_nivel$Ámbito.de.estudio]]
  df_nivel$Rama.de.enseñanza <- ambitos_estudio_ramas_enseñanza[[df_nivel$Ámbito.de.estudio]]
  
  if (!has_key(zonas_nacionalidad, df_nivel$Zona.de.nacionalidad)) {
    cat("Posibles valores para Zona.de.nacionalidad:", paste(keys(zonas_nacionalidad), collapse = ", "))
    stop("Asígnele un valor válido a Zona.de.nacionalidad")
  }
  df_nivel$Zona.de.nacionalidad <- zonas_nacionalidad[[df_nivel$Zona.de.nacionalidad]]

  df_pca_comunidad <- agregar_datos_pca(df_nivel, data, "Comunidad.Autónoma", "Comunidad.")
  df_pca_rama_enseñanza <- agregar_datos_pca(df_pca_comunidad, data, "Rama.de.enseñanza", "Rama.")
  df_pca_ambito_estudio <- agregar_datos_pca(df_pca_rama_enseñanza, data, "Ámbito.de.estudio", "Ámbito.")
  df_pca_zona_nacionalidad <- agregar_datos_pca(df_pca_ambito_estudio, data, "Zona.de.nacionalidad", "Zona.de.nacionalidad.")
  
  return(df_pca_zona_nacionalidad)
}
```

### 3.4. Input del usuario

```{r}
nuevos_datos_rf <- data.frame(
    Comunidad.Autónoma = "Andalucía",
    Sexo = "Hombres",
    Forma.de.admisión = "PAU",
    Ámbito.de.estudio = "Economía",
    Zona.de.nacionalidad = "España"
)

head(nuevos_datos_rf)
```

```{r}

df_prediccion <- adaptar_dataframe(nuevos_datos_rf)
head(df_prediccion)
```

### 3.5. Predicciones sobre Random Forest

```{r}

predicciones <- predict(model_rf, newdata = df_prediccion)

# Imprimir las predicciones
print(predicciones[1]*14)
```

### 3.6. Predicciones sobre Decision Tree

```{r}

predicciones <- predict(model_tree, newdata = df_prediccion)

# Imprimir las predicciones
print(predicciones[1]*14)
```
