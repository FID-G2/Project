# Modelo de regresión

## Imports necesarios

```{r}
#install.packages("caret")
#install.packages("rpart")
#install.packages("lightgbm")
#install.packages("randomForest")
```

```{r}
library(randomForest)
library(caret)
library(rpart)
library(lightgbm)
```

## 1. Lectura de los datos

Lectura de los datos obtenidos tras aplicar el proceso de selección.

```{r}

df <- read.csv("../data/CleanData/datos_seleccion_atributos.csv")
control <- trainControl(method = "cv", number = 10)
```

## 2. Modelos

### 2.1. Random Forest

```{r}

model_rf <- train(Nota.media ~ ., data = df, method = "rf", trControl = control, tuneGrid = data.frame(mtry = 2), ntree = 10)
print(model_rf)
```

### 2.2. LightGBM

```{r}

data <- as.matrix(df[, -which(names(df) == "Nota.media")])
label <- df$Nota.media

# Crear un conjunto de datos de LightGBM
lgb_data <- lgb.Dataset(data = data, label = label)

# Especificar los parámetros del modelo
params <- list(objective = "regression",
               metric = list("rmse","mse", "mae"), #TODO: Ver como se puede modificar esto para que salgan todas las métricas
               num_leaves = 31,
               learning_rate = 0.05,
               nthread = 2,
               max_depth = 2,
               min_data_in_leaf = 20)

# Entrenar el modelo con validación cruzada
cv_results <- lgb.cv(params,
                     data = lgb_data,
                     nrounds = 10,
                     nfold = 10,
                     verbose = 0)

# Mostrar los resultados
print(cv_results)
```

**RMSE**

```{r}

cv_results$record_evals$valid$rmse
```

**MAE**

```{r}

cv_results$record_evals$valid$l1
```

**MSE**

```{r}

cv_results$record_evals$valid$l2
```

### 2.3. Decision Tree

```{r}

model_tree <- train(Nota.media ~ ., data = df, method = "rpart", trControl = control, control = rpart.control(cp = 1))

print(model_tree)

```


# --------------------------------

## Funciones de codificación y reducción de la dimensionalidad

```{r}
reduce_dimensionality <- function(data, patterns, new_names) {
  if (length(patterns) != length(new_names)) {
    stop("Las listas de patrones y nombres nuevos deben tener la misma longitud")
  }

  for (i in seq_along(patterns)) {
    columns <- grepl(patterns[i], colnames(data))
    
    data_columns <- data[, columns, drop = FALSE]

    # Manejar datos faltantes
    data_columns <- na.omit(data_columns)

    # Escalar los datos
    data_columns <- scale(data_columns)

    # Realizar PCA con prcomp en lugar de princomp
    pca_result <- prcomp(data_columns, scale. = TRUE)

    # Seleccionar los primeros N componentes principales
    N <- min(ncol(data_columns), 3)  # Limitar a un máximo de 3 componentes
    pca_columns <- pca_result$x[, 1:N]

    new_column_names <- paste0(new_names[i], ".PCA", 1:N)

    data <- data[, !columns]
    data <- cbind(data, setNames(as.data.frame(pca_columns), new_column_names))
  }

  return(data)
}

binary_encode <- function(data, variable, category1, category2) {
  # Crear una nueva columna con la codificación binaria
  data[[variable]] <- ifelse(data[[variable]] == category1, 0, 1)

  # Devolver el conjunto de datos modificado
  return(data)
}
```

# ENTRADA DEL USUARIO
    
```{r}
    nuevos_datos_rf <- data.frame(

        Comunidad.Autónoma = "Andalucía",
        Universidad = "Sevilla",
        Sexo = "Hombres",
        Forma.de.admisión = "PAU",
        Rama.de.enseñanza = "Ciencias Sociales y Jurídicas",
        Ámbito.de.estudio = "Economía",
        Zona.de.nacionalidad = "España"
)
```

# Diccionarios

```{r}

# Comunidades Autónomas
comunidades_autonomas <- c("Comunidad.AutónomaAndalucía","Comunidad.AutónomaAragón", "Comunidad.AutónomaAsturias", "Comunidad.AutónomaCantabria", 
                           "Comunidad.AutónomaCastilla y León", "Comunidad.AutónomaCataluña", "Comunidad.AutónomaExtremadura", 
                           "Comunidad.AutónomaGalicia", "Comunidad.AutónomaLa Rioja", "Comunidad.AutónomaMadrid", 
                           "Comunidad.AutónomaMurcia", "Comunidad.AutónomaNavarra", "Comunidad.AutónomaPaís Vasco")

# Crear diccionario
diccionario_comunidades <- setNames(seq_along(comunidades_autonomas), comunidades_autonomas)

# Imprimir el diccionario
print(diccionario_comunidades)


# Universidades
# Datos proporcionados
universidades <- c("UniversidadAlcalá", "UniversidadAlicante", "UniversidadAutónoma de Barcelona", 
                   "UniversidadAutónoma de Madrid", "UniversidadBarcelona", "UniversidadBurgos", 
                   "UniversidadCádiz", "UniversidadCantabria", "UniversidadCarlos III de Madrid", 
                   "UniversidadCastilla-La Mancha", "UniversidadComplutense de Madrid", "UniversidadCórdoba", 
                   "UniversidadExtremadura", "UniversidadGirona", "UniversidadGranada", "UniversidadHuelva", 
                   "UniversidadIlles Balears (Les)", "UniversidadJaén", "UniversidadJaume I de Castellón", 
                   "UniversidadLa Laguna", "UniversidadLa Rioja", "UniversidadLas Palmas de Gran Canaria", 
                   "UniversidadLeón", "UniversidadLleida", "UniversidadMálaga", "UniversidadMiguel Hernández de Elche", 
                   "UniversidadMurcia", "UniversidadOviedo", "UniversidadPablo de Olavide", 
                   "UniversidadPaís Vasco/Euskal Herriko Unibertsitatea", "UniversidadPolitécnica de Cartagena", 
                   "UniversidadPolitécnica de Catalunya", "UniversidadPolitécnica de Madrid", 
                   "UniversidadPolitècnica de València", "UniversidadPompeu Fabra", "UniversidadPública de Navarra", 
                   "UniversidadRey Juan Carlos", "UniversidadRovira i Virgili", "UniversidadSalamanca", 
                   "UniversidadSantiago de Compostela", "UniversidadSevilla", "UniversidadValència (Estudi General)", 
                   "UniversidadValladolid", "UniversidadVigo", "UniversidadZaragoza")

# Crear diccionario
diccionario_universidades <- setNames(seq_along(universidades), universidades)

# Imprimir el diccionario
print(diccionario_universidades)

# Ramas de enseñanza
ramas_enseñanza <- c("Rama.de.enseñanzaCiencias", "Rama.de.enseñanzaCiencias de la Salud", 
                     "Ciencias Sociales y Jurídicas", "Rama.de.enseñanzaIngeniería y Arquitectura")

# Crear diccionario
diccionario_ramas_enseñanza <- setNames(seq_along(ramas_enseñanza), ramas_enseñanza)

# Imprimir el diccionario
print(diccionario_ramas_enseñanza)

# Ámbito de estudio
ambito_estudio <- c("Ámbito.de.estudioArquitectura y construcción", "Ámbito.de.estudioArtes", 
                    "Ámbito.de.estudioCiencias de la vida", "Ámbito.de.estudioCiencias Físicas, químicas, geológicas", 
                    "Ámbito.de.estudioDerecho", "Economía", "Ámbito.de.estudioEnfermería y atención a enfermos", 
                    "Ámbito.de.estudioHumanidades", "Ámbito.de.estudioInformática", "Ámbito.de.estudioIngenierías", 
                    "Ámbito.de.estudioLenguas", "Ámbito.de.estudioMedicina", "Ámbito.de.estudioPeriodismo e información", 
                    "Ámbito.de.estudioTrabajo social y orientación")

# Crear diccionario
diccionario_ambito_estudio <- setNames(seq_along(ambito_estudio), ambito_estudio)

# Imprimir el diccionario
print(diccionario_ambito_estudio)

# Zona de nacionalidad
zona_nacionalidad <- c("Zona.de.nacionalidadAsia y Oceanía", "Zona.de.nacionalidadEEUU y Canadá", 
                       "España", "Zona.de.nacionalidadNorte de África", 
                       "Zona.de.nacionalidadResto de África", "Zona.de.nacionalidadResto de Europa", 
                       "Zona.de.nacionalidadUnión Europea")

# Crear diccionario
diccionario_zona_nacionalidad <- setNames(seq_along(zona_nacionalidad), zona_nacionalidad)

# Imprimir el diccionario
print(diccionario_zona_nacionalidad)


```
```{r}
# Crear una fila única con un valor de 1 en la columna correspondiente
nueva_fila_codificada <- as.data.frame(t(apply(nuevos_datos_rf, 1, function(row) {
  result <- numeric(2+length(diccionario_comunidades) +
                    length(diccionario_universidades) +
                    length(diccionario_ramas_enseñanza) +
                    length(diccionario_ambito_estudio) +
                    length(diccionario_zona_nacionalidad))
  
  result[as.numeric(row["Comunidad.Autónoma"])] <- 1
  result[as.numeric(row["Universidad"])] <- 1
  result[as.numeric(row["Rama.de.enseñanza"])] <- 1
  result[as.numeric(row["Ámbito.de.estudio"])] <- 1
  result[as.numeric(row["Zona.de.nacionalidad"])] <- 1
  
  return(result)
})))

# Asignar nombres de columna
colnames(nueva_fila_codificada) <- c("Sexo","Forma.de.admisión",names(diccionario_comunidades),
                                     names(diccionario_universidades),
                                     names(diccionario_ramas_enseñanza),
                                     names(diccionario_ambito_estudio),
                                     names(diccionario_zona_nacionalidad))

# Aplicar las funciones de codificación
df_genero <- binary_encode(nueva_fila_codificada, "Sexo", "Hombres", "Mujeres")
df_nivel <- binary_encode(df_genero, "Forma.de.admisión", "PAU", "FP")

# Agregar las columnas al principio del dataframe
df_final <- cbind(df_nivel[, c("Sexo", "Forma.de.admisión")], df_nivel[, -c(1, 2)])

# Exportar a CSV
write.csv(df_final, "./data/CleanData/nuevos_datos_codificados.csv", row.names = FALSE)

```


```{r}
# Crear una nueva fila codificada con 0's
# Crear una nueva fila codificada con 0's
nueva_fila_codificada <- as.data.frame(matrix(0, ncol = ncol(df_final), nrow = 1))
colnames(nueva_fila_codificada) <- colnames(df_final)

# Definir las columnas específicas
columnas_especificas <- c("Comunidad.Autónoma", "Universidad", "Rama.de.enseñanza", "Ámbito.de.estudio", "Zona.de.nacionalidad")
diccionarios_list <- list(diccionario_comunidades, diccionario_universidades, diccionario_ramas_enseñanza, diccionario_ambito_estudio, diccionario_zona_nacionalidad)
columnas_especificas <- rep(columnas_especificas, sapply(diccionarios_list, length))

# Asignar 1 en las columnas específicas según los valores proporcionados en nuevos_datos_rf
for (i in seq_along(columnas_especificas)) {
  col_name <- paste0(columnas_especificas[i], nuevos_datos_rf[[columnas_especificas[i]]])
  nueva_fila_codificada[, col_name] <- 1
}


# Actualizar las columnas existentes en df_final
df_final[, colnames(nueva_fila_codificada)] <- nueva_fila_codificada

df_genero <- binary_encode(df_final, "Sexo", "Hombres", "Mujeres")
df_nivel <- binary_encode(df_genero, "Forma.de.admisión", "PAU", "FP")
# Exportar a CSV

#Añadir al CSV una fila determinada llena de 0's
df_nivel <- rbind(df_nivel, nueva_fila_codificada)

write.csv(df_nivel, "./data/CleanData/nuevos_datos_codificados.csv", row.names = FALSE)
```
```

```{r}
# Leer el conjunto de datos
df <- read.csv("./data/CleanData/nuevos_datos_codificados.csv")

patterns <- c("^Comunidad", "^Rama", "^Ámbito", "^Zona.de.nacionalidad")
new_names <- c("Comunidad", "Rama", "Ámbito", "Zona.de.nacionalidad")
df_res <- reduce_dimensionality(df, patterns, new_names)

# Exportar a CSV
write.csv(df_res, "./data/CleanData/datos_entrada_seleccion_atributos.csv", row.names = FALSE)

```