```{r}
library(dplyr)
library(magrittr)
library(caret)
```

```{r}
crear_interaccion <- function(data, columnas, nombre_interaccion, mantener_columnas_originales = FALSE) {
  interaccion <- interaction(data %>% select(columnas), sep = "_")
  data <- data %>%
    mutate({{nombre_interaccion}} := interaccion)
  
  if (!mantener_columnas_originales) {
    data <- data %>%
      select(-one_of(columnas))
  }
  
  return(data)
}

```

## Codificación One-Hot Encode

```{r}

# Función para realizar One-Hot Encoding
one_hot_encode <- function(data, variable) {
  # Obtener la matriz codificada
  encoded_matrix <- model.matrix(~ . - 1, data = data[, variable, drop = FALSE])

  # Convertir la matriz a un data frame
  encoded_df <- as.data.frame(encoded_matrix)

  # Obtener los nombres de las nuevas columnas
  # new_column_names <- colnames(encoded_df) # ¿BORRAR?

  # Eliminar la columna original
  data <- data[, !grepl(variable, colnames(data))] 

  # Agregar las nuevas columnas al conjunto de datos original
  data <- cbind(data, encoded_df[, -1, drop = FALSE])

  # Devolver el conjunto de datos modificado
  return(data)
}
```

## Variables binarias

```{r}

# Función para realizar la codificación binaria
binary_encode <- function(data, variable, category1, category2) {
  # Crear una nueva columna con la codificación binaria
  data[[variable]] <- ifelse(data[[variable]] == category1, 0, 1)

  # Devolver el conjunto de datos modificado
  return(data)
}
```

```{r}
datos = read.csv('./data/CleanData/datos_tratados.csv')
```

```{r}
datos_transf <- datos %>%
  group_by(Rama.de.enseñanza, Ámbito.de.estudio) %>%
  mutate(Nota.media = mean(Nota.media) + rnorm(n(), mean = 0, sd = 2)) %>%
  ungroup()
```
## Nueva columnas, interacciones entre diferentes variables

```{r}
# datos_transf <- crear_interaccion(datos_transf, c("Rama.de.enseñanza", "Ámbito.de.estudio"), Interaccion_Rama_Ambito, TRUE)

# datos_transf <- crear_interaccion(datos_transf, c("Sexo", "Ámbito.de.estudio","Rama.de.enseñanza"), Interaccion_Sexo_Rama_Ambito, TRUE)
```
## Columna diferencia entre nota media y nota media por comunidad

```{r}
#datos_transf <- datos_transf %>%
#  group_by(`Comunidad.Autónoma`) %>%
#  mutate(Diferencia_Nota_Media = Nota.media - mean(Nota.media)) %>%
#  ungroup()

# datos_transf
```

## 2. Normalización

```{r}
# Seleccionar las columnas numéricas para normalizar
columnas_numericas <- datos_transf[, c("Nota.media", "Número.de.estudiantes")]
```

## Normalizamos las columnas numéricas
```{r}
datos_normalizados <- scale(columnas_numericas)
```

## Agregamos los datos normalizados al conjunto de datos original

```{r}
datos_transf[,  c("Nota.media", "Número.de.estudiantes")] <- datos_normalizados
```

## 2. Escalado

```{r}
# Escalar los datos al rango 0-1
escalador <- preProcess(columnas_numericas, method = c("range"))
datos_escalados <- predict(escalador, newdata = columnas_numericas)

# Agregar los datos escalados al conjunto de datos original
datos_transf[, c("Nota.media", "Número.de.estudiantes")] <- datos_escalados
```

## One-Hot sobre el dataset

```{r}

# Uso de la función para codificar "Ciudad"
df_ciudad_encoded <- one_hot_encode(datos_transf, "Comunidad.Autónoma")
```

```{r}
# Uso de la función para codificar "Universidad"
df_universidad_encoded <- one_hot_encode(df_ciudad_encoded, "Universidad")
```
```{r}

# Uso de la función para codificar "Campo"
df_campo_encoded <- one_hot_encode(df_universidad_encoded, "Rama.de.enseñanza")
```

```{r}
# Uso de la función para codificar "Carrera"
df_carrera_encoded <- one_hot_encode(df_campo_encoded, "Ámbito.de.estudio")
```

```{r}
# Uso de la función para codificar "Zona de nacionalidad"
df_zona_encoded <- one_hot_encode(df_carrera_encoded, "Zona.de.nacionalidad")
```

```{r}
##df_rama_ambito_encoded <- one_hot_encode(df_carrera_encoded, "Interaccion_Rama_Ambito")
```

```{r}
##df_sexo_rama_ambito_encoded <- one_hot_encode(df_rama_ambito_encoded, "Interaccion_Sexo_Rama_Ambito")
```

## Codificación binaria sobre el dataset

```{r}
# Uso de la función para codificar "Genero"
df_genero <- binary_encode(df_zona_encoded, "Sexo", "Hombres", "Mujeres")
```

```{r}

# Uso de la función para codificar "Forma de admisión"
df_nivel <- binary_encode(df_genero, "Forma.de.admisión", "PAU", "FP")
```

## Exportación a CSV

```{r}
# Especifica el nombre del archivo CSV para los datos normalizados
nombre_archivo <- "./data/CleanData/datos_transformados.csv"

# Guarda los datos normalizados en un nuevo archivo CSV
write.csv(df_nivel, file = nombre_archivo, row.names = FALSE)

# Imprime un mensaje de confirmación
cat("Datos normalizados exportados a", nombre_archivo, "\n")

```
